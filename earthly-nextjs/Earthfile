#
# DO NOT MODIFY - generated by @zondax/cli
#
# Reference: https://github.com/vercel/next.js/tree/canary/examples/with-docker
VERSION 0.7
FROM node:18-alpine
ARG --global BASE_NAME=web-beryx
ENV NODE_ENV production
ENV NEXT_TELEMETRY_DISABLED 1

# Check https://github.com/nodejs/docker-node/tree/b4117f9333da4138b03a546ec926ef50a31506c3#nodealpine to understand why libc6-compat might be needed.
RUN apk add --no-cache libc6-compat

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs
WORKDIR /app

build-base:
    DO ../+GET_SOURCE_CODE
    RUN yarn install
    RUN yarn build
    SAVE ARTIFACT /app

build-production:
    # This could be optimized. Keeping it simple for now
    COPY --chown=nextjs:nodejs +build-base/app .

    # COPY --chown=nextjs:nodejs +build-base/app/package.json ./package.json
    # COPY --chown=nextjs:nodejs +build-base/app/node_modules ./node_modules
    # COPY --chown=nextjs:nodejs +build-base/app/.next ./.next

    USER nextjs
    EXPOSE 3000
    ENV PORT 3000
    CMD ["yarn", "start"]

    DO ../+PUBLISH_WITH_FLEXTAGS --CONTAINER_FULLNAME=${BASE_NAME}

all:
    BUILD +build-production
